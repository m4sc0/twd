name: Create Release
on:
  push:
    tags:
      - "v*"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Get version from __init__.py
      id: get_version
      run: |
        VERSION=$(grep -oP '__version__ = "\K[^"]+' src/twd/__init__.py)
        TAG_VERSION="${GITHUB_REF_NAME#v}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
        echo "Version from code: $VERSION"
        echo "Tag version: $TAG_VERSION"

    - name: Verify version matches tag
      run: |
        if [ "$VERSION" != "$TAG_VERSION" ]; then
          echo "Version mismatch! __init__.py has $VERSION but tag is $TAG_VERSION"
          exit 1
        fi
        echo "Version matches tag"

    - name: Create Github Release
      run: |
        gh release create ${{ github.ref_name }} \
          --title "${{ github.ref_name }}" \
          --generate-notes

      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
